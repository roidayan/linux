From: Yishai Hadas <yishaih@mellanox.com>
Subject: [PATCH] BACKPORTS: ib/ipoib: fix offloads for UD mode

Change-Id: I9171f0de6ee1296e30296d1c9869a4a3c9208041
Signed-off-by: Yishai Hadas <yishaih@mellanox.com>
---
 drivers/infiniband/ulp/ipoib/ipoib.h         |    3 +++
 drivers/infiniband/ulp/ipoib/ipoib_ethtool.c |   13 +++++++++++++
 drivers/infiniband/ulp/ipoib/ipoib_main.c    |   12 +++++++-----
 3 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/drivers/infiniband/ulp/ipoib/ipoib.h b/drivers/infiniband/ulp/ipoib/ipoib.h
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib.h
+++ b/drivers/infiniband/ulp/ipoib/ipoib.h
@@ -103,6 +103,9 @@ enum {
 	IPOIB_FLAG_AUTO_MODER     = 13, /*indicates moderation is running*/
 
 	IPOIB_MAX_BACKOFF_SECONDS = 16,
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(2,6,39))
+	IPOIB_FLAG_CSUM	= 17,
+#endif
 
 	IPOIB_MCAST_FLAG_FOUND	  = 0,	/* used in set_multicast_list */
 	IPOIB_MCAST_FLAG_SENDONLY = 1,
diff --git a/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c b/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
@@ -316,6 +316,15 @@ int ipoib_set_flags(struct net_device *dev, u32 data)
 }
 #endif
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(2,6,39))
+static u32 ipoib_get_rx_csum(struct net_device *dev)
+{
+	struct ipoib_dev_priv *priv = netdev_priv(dev);
+	return test_bit(IPOIB_FLAG_CSUM, &priv->flags) &&
+		!test_bit(IPOIB_FLAG_ADMIN_CM, &priv->flags);
+}
+#endif
+
 static const struct ethtool_ops ipoib_ethtool_ops = {
 	.get_drvinfo		= ipoib_get_drvinfo,
 	.get_coalesce		= ipoib_get_coalesce,
@@ -331,6 +340,10 @@ static const struct ethtool_ops ipoib_ethtool_ops = {
 	.set_flags		= ipoib_set_flags,
 	.get_flags              = ethtool_op_get_flags,
 #endif
+#if (LINUX_VERSION_CODE <  KERNEL_VERSION(2,6,39))
+       .get_rx_csum            = ipoib_get_rx_csum,
+#endif
+
 };
 
 void ipoib_set_ethtool_ops(struct net_device *dev)
diff --git a/drivers/infiniband/ulp/ipoib/ipoib_main.c b/drivers/infiniband/ulp/ipoib/ipoib_main.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@ -284,11 +284,12 @@ int ipoib_set_mode(struct net_device *dev, const char *buf)
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,39))
 		netdev_update_features(dev);
 #else
-		dev->features &= ~(NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_TSO);
-		if (ipoib_cm_max_mtu(dev) > priv->mcast_mtu)
-			ipoib_warn(priv, "mtu > %d will cause multicast packet drops.\n",
-				   priv->mcast_mtu);
-		dev_set_mtu(dev, ipoib_cm_max_mtu(dev));
+		if (test_bit(IPOIB_FLAG_CSUM, &priv->flags)) {
+			dev->features |= NETIF_F_IP_CSUM | NETIF_F_SG;
+
+			if (priv->hca_caps & IB_DEVICE_UD_TSO)
+				dev->features |= NETIF_F_TSO;
+		}
 #endif
 		dev_set_mtu(dev, min(priv->mcast_mtu, dev->mtu));
 		rtnl_unlock();
@@ -2459,6 +2460,7 @@ int ipoib_set_dev_features(struct ipoib_dev_priv *priv, struct ib_device *hca)
 
 		priv->dev->features |= priv->dev->hw_features;
 #else
+		set_bit(IPOIB_FLAG_CSUM, &priv->flags);
 		priv->dev->features |= NETIF_F_SG |
 			NETIF_F_IP_CSUM | NETIF_F_RXCSUM;
 
