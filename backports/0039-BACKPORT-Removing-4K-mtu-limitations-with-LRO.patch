From: root <root@dev-ovm-023.vmlab.mtl.com>
Subject: BACKPORT: Removing 4K mtu limitations with LRO

---
 drivers/infiniband/ulp/ipoib/ipoib_ethtool.c |    9 ---------
 drivers/infiniband/ulp/ipoib/ipoib_main.c    |   14 +-------------
 2 files changed, 1 insertions(+), 22 deletions(-)

diff --git a/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c b/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_ethtool.c
@@ -302,16 +302,7 @@ static int ipoib_set_channels(struct net_device *dev,
 #ifdef CONFIG_COMPAT_USE_LRO
 int ipoib_set_flags(struct net_device *dev, u32 data)
 {
-	struct ipoib_dev_priv *priv = netdev_priv(dev);
-
 	ethtool_op_set_flags(dev, data);
-	/*no support in LRO with 4k mtu.*/
-	if (ipoib_ud_need_sg(priv->max_ib_mtu) && (data & NETIF_F_LRO)) {
-
-		priv->dev->features  &= ~NETIF_F_LRO;
-		return -EOPNOTSUPP;
-	}
-
 	return 0;
 }
 #endif
diff --git a/drivers/infiniband/ulp/ipoib/ipoib_main.c b/drivers/infiniband/ulp/ipoib/ipoib_main.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@ -1993,9 +1993,6 @@ void set_lro_features_bit(struct ipoib_dev_priv *priv)
 {
 	if (lro)
 		priv->dev->features |= NETIF_F_LRO;
-	/*no support in LRO with 4k mtu.*/
-	if (ipoib_ud_need_sg(priv->max_ib_mtu))
-		priv->dev->features  &= ~NETIF_F_LRO;
 }
 #endif
 
@@ -2500,16 +2497,7 @@ static struct net_device *ipoib_add_port(const char *format,
 
 	if (!ib_query_port(hca, port, &attr)) {
 		priv->max_ib_mtu = ib_mtu_enum_to_int(attr.max_mtu);
-#ifdef CONFIG_COMPAT_USE_LRO
-	/* To enable LRO we set max MTU to 2K*/
-		if (lro) {
-			printk(KERN_WARNING "LRO forced max mtu to be 2K for ipoib, port=%d",
-				port);
-			priv->max_ib_mtu = 2048;
-		}
-#endif
-	}
-	else {
+	} else {
 		printk(KERN_WARNING "%s: ib_query_port %d failed\n",
 		       hca->name, port);
 		goto device_init_failed;
